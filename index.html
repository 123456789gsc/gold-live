<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å›½é™…é‡‘ä»·å®æ—¶è¡Œæƒ…</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #0d1117 0%, #161b22 100%);
            min-height: 100vh; color: #fff; padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            padding-bottom: max(16px, env(safe-area-inset-bottom));
        }
        .container { max-width: 600px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 20px; }
        header h1 {
            font-size: 1.6rem; font-weight: 700;
            background: linear-gradient(90deg, #ffd700, #ffed4a);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .status-bar {
            display: flex; align-items: center; justify-content: center;
            gap: 10px; flex-wrap: wrap;
        }
        .live-indicator {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;
        }
        .live-indicator.connected { background: rgba(0,200,83,0.15); color: #00c853; }
        .live-indicator.loading { background: rgba(255,215,0,0.15); color: #ffd700; }
        .live-indicator.error { background: rgba(255,82,82,0.15); color: #ff5252; }
        .live-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: currentColor; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
        .update-time { color: #8b949e; font-size: 0.75rem; }
        
        .main-card {
            background: linear-gradient(145deg, rgba(255,215,0,0.1), rgba(255,215,0,0.02));
            border: 1px solid rgba(255,215,0,0.2);
            border-radius: 20px; padding: 24px; margin-bottom: 16px;
            text-align: center;
        }
        .main-card .label { color: #8b949e; font-size: 0.85rem; margin-bottom: 8px; }
        .main-card .price {
            font-size: 3rem; font-weight: 700; color: #ffd700;
            line-height: 1.1; margin-bottom: 12px;
            transition: color 0.3s;
        }
        .main-card .price.flash-up { color: #00ff88; }
        .main-card .price.flash-down { color: #ff4444; }
        .change-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .change-badge {
            padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; font-weight: 600;
        }
        .change-badge.positive { background: rgba(0,200,83,0.2); color: #00c853; }
        .change-badge.negative { background: rgba(255,82,82,0.2); color: #ff5252; }
        
        .price-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;
        }
        .price-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 16px; padding: 16px; text-align: center;
        }
        .price-card .label { color: #8b949e; font-size: 0.75rem; margin-bottom: 6px; }
        .price-card .value { font-size: 1.3rem; font-weight: 600; }
        .price-card .value.gold { color: #ffd700; }
        .price-card .value.silver { color: #c0c0c0; }
        .price-card .value.cny { color: #ff6b6b; }
        .price-card .sub { color: #8b949e; font-size: 0.7rem; margin-top: 4px; }
        
        .info-row {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;
        }
        .info-item {
            background: rgba(255,255,255,0.02); border-radius: 12px; padding: 12px; text-align: center;
        }
        .info-item .label { color: #8b949e; font-size: 0.65rem; margin-bottom: 4px; }
        .info-item .value { font-size: 0.95rem; font-weight: 600; color: #fff; }
        
        .chart-container {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px; padding: 16px; margin-bottom: 16px;
        }
        .chart-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px;
        }
        .chart-title { font-size: 0.9rem; color: #ffd700; }
        .chart-wrapper { height: 200px; }
        
        .refresh-btn {
            width: 100%; padding: 14px;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            border: none; border-radius: 14px;
            color: #000; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: transform 0.2s, opacity 0.2s;
        }
        .refresh-btn:active { transform: scale(0.98); }
        .refresh-btn:disabled { opacity: 0.5; }
        
        .footer {
            text-align: center; color: #484f58; font-size: 0.7rem;
            padding: 16px 0; line-height: 1.6;
        }
        .footer a { color: #ffd700; text-decoration: none; }
        
        .error-msg {
            background: rgba(255,82,82,0.1);
            border: 1px solid rgba(255,82,82,0.2);
            border-radius: 12px; padding: 12px;
            color: #ff8a8a; font-size: 0.85rem;
            text-align: center; margin-bottom: 16px;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ† å›½é™…é»„é‡‘å®æ—¶è¡Œæƒ…</h1>
        <div class="status-bar">
            <span class="live-indicator loading" id="status">
                <span class="live-dot"></span>
                <span id="statusText">è¿æ¥ä¸­...</span>
            </span>
            <span class="update-time" id="updateTime">--</span>
        </div>
    </header>
    
    <div id="errorBox"></div>
    
    <div class="main-card">
        <div class="label">XAU/USD ç°è´§é‡‘ä»· (ç¾å…ƒ/ç›å¸)</div>
        <div class="price" id="goldPrice">--</div>
        <div class="change-row" id="goldChange">
            <span class="change-badge positive">--</span>
            <span class="change-badge positive">--</span>
        </div>
    </div>
    
    <div class="price-grid">
        <div class="price-card">
            <div class="label">äººæ°‘å¸é‡‘ä»·</div>
            <div class="value cny" id="goldCNY">--</div>
            <div class="sub">å…ƒ/å…‹</div>
        </div>
        <div class="price-card">
            <div class="label">XAG/USD é“¶ä»·</div>
            <div class="value silver" id="silverPrice">--</div>
            <div class="sub">ç¾å…ƒ/ç›å¸</div>
        </div>
    </div>
    
    <div class="info-row">
        <div class="info-item">
            <div class="label">æ˜¨æ—¥æ”¶ç›˜</div>
            <div class="value" id="prevClose">--</div>
        </div>
        <div class="info-item">
            <div class="label">é‡‘ä»· ($/å…‹)</div>
            <div class="value" id="goldGram">--</div>
        </div>
        <div class="info-item">
            <div class="label">é‡‘é“¶æ¯”</div>
            <div class="value" id="ratio">--</div>
        </div>
    </div>
    
    <div class="chart-container">
        <div class="chart-header">
            <span class="chart-title">ğŸ“ˆ ä»·æ ¼èµ°åŠ¿</span>
        </div>
        <div class="chart-wrapper">
            <canvas id="priceChart"></canvas>
        </div>
    </div>
    
    <button class="refresh-btn" id="refreshBtn" onclick="fetchData()">
        åˆ·æ–°æ•°æ®
    </button>
    
    <div class="footer">
        <p>æ•°æ®æ¥æºï¼šYahoo Finance (GC=F, SI=F)</p>
        <p>æ¶¨è·Œå¹…ç›¸æ¯”æ˜¨æ—¥æ”¶ç›˜ä»· Â· æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–°</p>
        <p>ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®</p>
    </div>
</div>

<script>
// é…ç½®
const CONFIG = {
    // CORS ä»£ç†åˆ—è¡¨
    corsProxies: [
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?'
    ],
    yahooGoldUrl: 'https://query1.finance.yahoo.com/v8/finance/chart/GC=F',
    yahooSilverUrl: 'https://query1.finance.yahoo.com/v8/finance/chart/SI=F',
    usdCny: 7.25,
    ozToGram: 31.1035,
    refreshInterval: 30000
};

// çŠ¶æ€
let state = {
    gold: 0,
    silver: 0,
    prevGold: 0,
    prevClose: 0,
    priceHistory: []
};

let chart = null;
let currentProxyIndex = 0;

// æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
function setStatus(type, text) {
    const el = document.getElementById('status');
    const textEl = document.getElementById('statusText');
    el.className = 'live-indicator ' + type;
    textEl.textContent = text;
}

function showError(msg) {
    document.getElementById('errorBox').innerHTML = `<div class="error-msg">${msg}</div>`;
}

function clearError() {
    document.getElementById('errorBox').innerHTML = '';
}

// é€šè¿‡ä»£ç†è·å–æ•°æ®
async function fetchWithProxy(url) {
    for (let i = 0; i < CONFIG.corsProxies.length; i++) {
        const proxyIndex = (currentProxyIndex + i) % CONFIG.corsProxies.length;
        const proxy = CONFIG.corsProxies[proxyIndex];
        
        try {
            const fullUrl = proxy + encodeURIComponent(url);
            const response = await fetch(fullUrl);
            
            if (response.ok) {
                const text = await response.text();
                currentProxyIndex = proxyIndex;
                return JSON.parse(text);
            }
        } catch (e) {
            console.log(`ä»£ç† ${proxyIndex} å¤±è´¥:`, e.message);
        }
    }
    throw new Error('æ— æ³•è·å–æ•°æ®');
}

// è§£æ Yahoo Finance æ•°æ®
function parseYahooData(data) {
    if (!data?.chart?.result?.[0]) {
        throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
    }
    
    const meta = data.chart.result[0].meta;
    const price = meta.regularMarketPrice;
    const prevClose = meta.previousClose || meta.chartPreviousClose || price;
    
    return {
        price,
        prevClose,
        change: price - prevClose,
        changePercent: ((price - prevClose) / prevClose) * 100
    };
}

// è·å–æ•°æ®
async function fetchData() {
    const btn = document.getElementById('refreshBtn');
    btn.disabled = true;
    btn.textContent = 'åŠ è½½ä¸­...';
    setStatus('loading', 'è·å–æ•°æ®...');
    clearError();
    
    try {
        // è·å–é‡‘ä»·
        const goldData = await fetchWithProxy(CONFIG.yahooGoldUrl);
        const gold = parseYahooData(goldData);
        
        // æ›´æ–°çŠ¶æ€
        state.prevGold = state.gold;
        state.gold = gold.price;
        state.prevClose = gold.prevClose;
        
        // è·å–é“¶ä»·
        try {
            const silverData = await fetchWithProxy(CONFIG.yahooSilverUrl);
            const silver = parseYahooData(silverData);
            state.silver = silver.price;
        } catch (e) {
            state.silver = state.gold / 88;
        }
        
        // è®°å½•å†å²
        state.priceHistory.push({ time: new Date(), price: state.gold });
        if (state.priceHistory.length > 60) state.priceHistory.shift();
        
        updateDisplay(gold);
        updateChart();
        
        setStatus('connected', 'å®æ—¶è¿æ¥');
        document.getElementById('updateTime').textContent = `æ›´æ–°: ${new Date().toLocaleTimeString('zh-CN')}`;
        
    } catch (error) {
        console.error('è·å–å¤±è´¥:', error);
        setStatus('error', 'è¿æ¥å¤±è´¥');
        showError('è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåç‚¹å‡»åˆ·æ–°');
    } finally {
        btn.disabled = false;
        btn.textContent = 'åˆ·æ–°æ•°æ®';
    }
}

// æ›´æ–°æ˜¾ç¤º
function updateDisplay(gold) {
    const priceEl = document.getElementById('goldPrice');
    priceEl.textContent = `$${state.gold.toFixed(2)}`;
    
    // é—ªçƒæ•ˆæœ
    if (state.prevGold > 0 && state.gold !== state.prevGold) {
        const flash = state.gold > state.prevGold ? 'flash-up' : 'flash-down';
        priceEl.classList.add(flash);
        setTimeout(() => priceEl.classList.remove(flash), 500);
    }
    
    // æ¶¨è·Œå¹…
    const isUp = gold.change >= 0;
    document.getElementById('goldChange').innerHTML = `
        <span class="change-badge ${isUp ? 'positive' : 'negative'}">
            ${isUp ? '+' : ''}${gold.change.toFixed(2)}
        </span>
        <span class="change-badge ${isUp ? 'positive' : 'negative'}">
            ${isUp ? '+' : ''}${gold.changePercent.toFixed(2)}%
        </span>
    `;
    
    // äººæ°‘å¸é‡‘ä»·
    const cnyPerGram = (state.gold * CONFIG.usdCny) / CONFIG.ozToGram;
    document.getElementById('goldCNY').textContent = `Â¥${cnyPerGram.toFixed(2)}`;
    document.getElementById('goldGram').textContent = `$${(state.gold / CONFIG.ozToGram).toFixed(2)}`;
    document.getElementById('prevClose').textContent = `$${state.prevClose.toFixed(2)}`;
    
    if (state.silver > 0) {
        document.getElementById('silverPrice').textContent = `$${state.silver.toFixed(2)}`;
        document.getElementById('ratio').textContent = (state.gold / state.silver).toFixed(1);
    }
}

// åˆå§‹åŒ–å›¾è¡¨
function initChart() {
    const ctx = document.getElementById('priceChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
    gradient.addColorStop(0, 'rgba(255,215,0,0.3)');
    gradient.addColorStop(1, 'rgba(255,215,0,0)');
    
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                data: [],
                borderColor: '#ffd700',
                backgroundColor: gradient,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#8b949e', maxTicksLimit: 5 } },
                y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { color: '#8b949e', callback: v => '$' + v } }
            }
        }
    });
}

// æ›´æ–°å›¾è¡¨
function updateChart() {
    if (!chart) return;
    chart.data.labels = state.priceHistory.map(p => p.time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }));
    chart.data.datasets[0].data = state.priceHistory.map(p => p.price);
    chart.update('none');
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    initChart();
    fetchData();
    setInterval(fetchData, CONFIG.refreshInterval);
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') fetchData();
    });
});
</script>
</body>
</html>
